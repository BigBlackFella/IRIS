##################################################################
## Resource Interaction Model (RIM) DSL velocity template
##################################################################
events
	GET GET
	POST POST
	PUT PUT
	DELETE DELETE
end

commands
#foreach ( $command in $commands.getRIMCommands() )
	$command
#end
end

initial resource ServiceDocument
	item ServiceDocument
	view { GETServiceDocument }
	path "/"
#foreach ( $rsm in $rim.getResourceStateMachines() )
	GET -> ${rsm.getCollectionState().getName()}
#end
end
## -----------------------------------------------------
## Resource state machines
## -----------------------------------------------------
#foreach ( $rsm in $rim.getResourceStateMachines() )
## ----- Resource state -----
#foreach ( $state in $rsm.getResourceStates() )
#if(!(${state.class.simpleName} == "IMNavigationState" && !${state.isNavigationToCollectionResource()} && !$strictOData))## Do not generate nav states to entity resources if strictOdata=false

#if($state.equals($rsm.getCollectionState()) || $state.equals($rsm.getEntityState()))
resource ${state.getName()}
#else
resource ${rsm.getEntityState().getName()}_${state.getName()}
#end
#if(${state.class.simpleName} == "IMNavigationState" && ${state.isNavigationToCollectionResource()})
	collection ${state.getTargetResourceStateMachine().getEntityName()}
	view { GETEntities filter=filter }
#elseif(${state.class.simpleName} == "IMNavigationState" && !${state.isNavigationToCollectionResource()})
	item ${state.getTargetResourceStateMachine().getEntityName()}
	view { GETNavProperty navproperty=navproperty, entity=${rsm.getEntityName()} }
#elseif($state.equals($rsm.getCollectionState()))
	collection ${rsm.getEntityName()}
	view { GETEntities }
#else
	item ${rsm.getEntityName()}
	view { GETEntity }
#end
#if(${state.class.simpleName} == "IMPseudoState" && $state.getActions().size() > 0)
	actions { ##
#foreach ( $action in $state.getActions() )
$action## 
#end
 }
#end
#if ($state.hasRelations())
	relations { "${state.getRelations()}" }
#end
#if(${state.class.simpleName} == "IMNavigationState")
	path "${rsm.getEntityState().getPath()}/${state.getPath()}"
#else
	path "${state.getPath()}"
#end
## ----- Transitions from an entity-type state or a pseudo state -----
#writeStateTransitions($rsm $state)
## ----- Transitions from collection type navigation state -----
#if(${state.class.simpleName} == "IMNavigationState" && ${state.isNavigationToCollectionResource()})
#writeCollectionStateTransitions($state.getTargetResourceStateMachine() $state)
#end
## ----- Transitions from an RSM's collection state -----
#if($state.equals($rsm.getCollectionState()))
#writeCollectionStateTransitions($rsm $state)
#end
end
#end
#end
#end
##
## -----------------------------------------------------
## writeCollectionStateTransitions
##       Macro to write outgoing transitions on a collection state 
## -----------------------------------------------------
#macro( writeCollectionStateTransitions $rsm $state )
	GET *-> ${rsm.getEntityState().getName()} id=${rsm.getMappedEntityProperty()}
#foreach ( $transition in $rsm.getEntityStateTransitions() )
#if(${transition.getTargetState().class.simpleName} == "IMPseudoState")
## Collection transition to a pseudo state
	${transition.getMethod()} ${transition.getTitleAssignment()}*-> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()}
#elseif (${transition.class.simpleName} == "IMStateTransition")
## State transition to this RSM's collection state
	${transition.getMethod()} ${transition.getTitleAssignment()}*-> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()} id=${rsm.getMappedEntityProperty()}
#elseif (${transition.class.simpleName} == "IMCollectionStateTransition") 
## Transition to a navigation state representing another RSM's collection state
	${transition.getMethod()} ${transition.getTitleAssignment()}*-> ${rsm.getEntityState().getName()}_${transition.getLinkProperty()} id=${rsm.getMappedEntityProperty()}, filter="${transition.getFilter()}"
#elseif(${transition.class.simpleName} == "IMEntityStateTransition" && $strictOData)
## Transition to a navigation state representing another RSM's entity state
	${transition.getMethod()} ${transition.getTitleAssignment()}*-> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()} id=${rsm.getMappedEntityProperty()}, navproperty="${transition.getTargetState().getName()}"
#else
	${transition.getMethod()} ${transition.getTitleAssignment()}*-> ${transition.getTargetResourceStateMachine().getEntityState().getName()} id=${transition.getLinkProperty()}
#end
#end
#end
##
## -----------------------------------------------------
## writeStateTransitions
##       Macro to write outgoing transitions on an entity-type or pseudo state 
## -----------------------------------------------------
#macro( writeStateTransitions $rsm $state )
#foreach ( $transition in $state.getTransitions() )
#if (${transition.class.simpleName} == "IMStateTransition" && $transition.isAutoTransition())
## Auto transition from pseudo state
	${transition.getMethod()} --> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()} (OK(${rsm.getEntityState().getName()}_${transition.getTargetState().getName()}))
#elseif(${transition.getTargetState().class.simpleName} == "IMPseudoState" && $transition.isBoundToCollection())
## Collection transition to a pseudo state
	${transition.getMethod()} ${transition.getTitleAssignment()}-> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()}
#elseif(${transition.class.simpleName} == "IMCollectionStateTransition")
## Transition to a navigation state representing another RSM's collection state
	${transition.getMethod()} ${transition.getTitleAssignment()}-> ${rsm.getEntityState().getName()}_${transition.getLinkProperty()} id=${rsm.getMappedEntityProperty()}, filter="${transition.getFilter()}"
#elseif(${transition.class.simpleName} == "IMEntityStateTransition" && $strictOData)
## Transition to a navigation state representing another RSM's entity state
	${transition.getMethod()} ${transition.getTitleAssignment()}-> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()} id=${rsm.getMappedEntityProperty()}, navproperty="${transition.getTargetState().getName()}"
#elseif(${transition.class.simpleName} == "IMEntityStateTransition" && !$strictOData)
## Transition to a navigation state representing another RSM's entity state
	${transition.getMethod()} ${transition.getTitleAssignment()}-> ${transition.getTargetResourceStateMachine().getEntityState().getName()} id=${transition.getLinkProperty()}
#else
## Transition to other state
	${transition.getMethod()} ${transition.getTitleAssignment()}-> ${rsm.getEntityState().getName()}_${transition.getTargetState().getName()} id=${rsm.getMappedEntityProperty()}
#end
#end
#end